<!DOCTYPE html>
<html>
  <head>
    <title>Baby Monitor</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div style="width: 100vw; height: 100vh; background-color: #f8f9fa">
      <div
        class="d-flex flex-column justify-content-start align-items-center h-100 py-3"
        style="gap: 1rem"
      >
        <!-- Connect Button -->
        <button
          class="btn btn-primary"
          id="connect-to-camera"
          style="
            width: 80%;
            max-width: 400px;
            height: 80px;
            font-size: 1.5rem;
            border-radius: 12px;
          "
        >
          Connect to Camera
        </button>

        <!-- Client ID -->
        <div
          id="client-id"
          style="font-size: 1.2rem; font-weight: 500; text-align: center"
        ></div>

        <!-- Connection Status -->
        <div
          id="is-alive-status"
          style="font-size: 1.2rem; font-weight: 500; text-align: center"
        ></div>

        <!-- Video -->
        <div
          class="d-flex justify-content-center align-items-center"
          style="width: 100%; flex-grow: 1"
        >
          <video
            id="remote-video"
            autoplay
            playsinline
            controls
            style="
              display: none;
              width: 100%;
              aspect-ratio: 4 / 3;
              object-fit: contain;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
              background-color: black;
            "
          ></video>
          <!-- <audio id="remote-audio" autoplay playsinline></audio> -->
        </div>
      </div>
    </div>

    <script>
      let ws;
      let pc;
      let lastPing;
      let combinedTrack = new MediaStream();
      const localId = "client_peer_" + Math.random().toString(36).slice(2, 10);

      const remoteId = "camera_peer";
      const connectToCameraBtn = document.getElementById("connect-to-camera");
      const clientIdDiv = document.getElementById("client-id");
      const isAliveDiv = document.getElementById("is-alive-status");

      if (connectToCameraBtn) {
        connectToCameraBtn.onclick = async function () {
          await connectToCamera();
        };
      }

      async function connectToCamera() {
        const pendingCandidates = [];

        ws = new WebSocket("ws://192.168.1.249:3000/ws");

        pc = new RTCPeerConnection();
        pc.addTransceiver("video", { direction: "recvonly" });
        pc.addTransceiver("audio", { direction: "recvonly" });

        setInterval(async () => {
          const stats = await pc.getStats();
          stats.forEach((report) => {
            if (report.type === "inbound-rtp" && report.kind === "audio") {
              console.log(
                `Audio received: packets=${report.packetsReceived}, bytes=${report.bytesReceived}`
              );
            }
          });
        }, 1000);

        pc.ontrack = async (event) => {
          const videoEl = document.getElementById("remote-video");
          if (event.track.kind === "video") {
            // Log stream info
            console.log(typeof event.streams[0]);
            combinedTrack.addTrack(event.streams[0].getTracks()[0]);
          }

          if (event.track.kind === "audio") {
            console.log(typeof event.streams[0].getTracks()[0]);
            combinedTrack.addTrack(event.streams[0].getTracks()[0]);
          }

          if (combinedTrack.getTracks().length == 2) {
            videoEl.srcObject = combinedTrack;
            try {
              await videoEl.play();
              videoEl.style.display = "";
              console.log("Video and Audio play() succeeded");
            } catch (error) {
              console.error("Video and Audio play() failed:", error);
            }
          }
        };

        // ICE candidates: send them to Rust signaling server
        pc.onicecandidate = (event) => {
          if (event.candidate) {
            ws.send(
              JSON.stringify({
                candidate: event.candidate.candidate,
                from: localId,
                to: remoteId,
              })
            );
          }
        };

        setInterval(() => {
          const now = Date.now();
          if (now - lastPing > 6000) {
            // 6 seconds threshold
            if (isAliveDiv) {
              isAliveDiv.textContent = "Connection Lost ⚠️";
            }
          }
        }, 1000);

        ws.onmessage = async (event) => {
          const msg = JSON.parse(event.data);
          if (msg.answer_to) {
            console.log("Received answer SDP");
            const remoteDesc = new RTCSessionDescription({
              type: "answer",
              sdp: msg.sdp,
            });

            if (clientIdDiv) {
              clientIdDiv.textContent = `ClientId: ${msg.answer_to}`;
            }
            await pc.setRemoteDescription(remoteDesc);
            console.log("Remote description set");

            // flush queued ICE candidates
            for (const c of pendingCandidates) {
              try {
                await pc.addIceCandidate(c);
              } catch (err) {
                console.error("Failed to add queued ICE candidate", err);
              }
            }
          } else if (msg.candidate) {
            const candidate = { candidate: msg.candidate };
            if (pc.remoteDescription) {
              // safe to add right away
              await pc.addIceCandidate(candidate);
            } else {
              // queue until remote desc is ready
              pendingCandidates.push(candidate);
            }
          } else if (msg.t && msg.t === "ping") {
            if (isAliveDiv) {
              lastPing = Date.now();
              isAliveDiv.textContent = "Connection Stable ✅";
            }
          }
        };

        ws.onopen = async () => {
          console.log("WebSocket connected, sending offer");
          // Create an offer and send it
          const offer = await pc.createOffer({ offerToReceiveVideo: true });
          await pc.setLocalDescription(offer);
          ws.send(
            JSON.stringify({
              sdp: offer.sdp,
              from: localId,
              offer_to: remoteId,
            })
          );
        };
      }
    </script>
  </body>
</html>
